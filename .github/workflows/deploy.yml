# ╔═══════════════════════════════════════════════════════════╗
# ║  LedgerPro — Production Deployment                       ║
# ║  SSH into VPS → Pull images → Restart services           ║
# ╚═══════════════════════════════════════════════════════════╝

name: Deploy

on:
  workflow_run:
    workflows: ["Docker Build"]
    types: [completed]
    branches: [main]

# Only one deployment at a time
concurrency:
  group: deploy-production
  cancel-in-progress: false

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest

    # Only deploy if the Docker build succeeded
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    # ── Requires manual approval in GitHub Settings ──
    # Go to: Settings → Environments → New environment "production"
    # Enable "Required reviewers" and add your team.
    environment:
      name: production
      url: https://${{ secrets.SERVER_HOST }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            set -euo pipefail

            # Navigate to project directory
            cd ~/ledgerpro

            # Pull latest images from GHCR
            docker compose pull

            # Restart services with zero-downtime
            docker compose up -d --remove-orphans

            # Clean up dangling images
            docker image prune -f

            echo " Deployment complete"
